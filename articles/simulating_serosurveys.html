<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulating Serosurveys • serofoi</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulating Serosurveys">
<!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZ471458FQ"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XZ471458FQ');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">
    <a href="https://epiverse-trace.github.io/" class="external-link"><img src="https://epiverse-trace.github.io/blueprints/logo_white.svg" id="logo" alt="Epiverse-TRACE"></a>
    <a class="navbar-brand me-2" href="../index.html">serofoi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/serofoi.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/foi_models.html">An Introduction To Force-of-Infection Models</a></li>
    <li><a class="dropdown-item" href="../articles/simulating_serosurveys.html">Simulating Serosurveys</a></li>
    <li><a class="dropdown-item" href="../articles/use_cases.html">Real-Life Use Cases For Serofoi</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/epiverse-trace/serofoi/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Simulating Serosurveys</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epiverse-trace/serofoi/blob/main/vignettes/articles/simulating_serosurveys.Rmd" class="external-link"><code>vignettes/articles/simulating_serosurveys.Rmd</code></a></small>
      <div class="d-none name"><code>simulating_serosurveys.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/epiverse-trace/serofoi" class="external-link">serofoi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<p>In this vignette, we show how it is possible to simulate serosurveys
using the <code>simulate_serosurvey</code> function. This function
separates two aspects: the serocatalytic model used to simulate
population-wide seropositivity throughout individuals’ lives; and the
features of the particular serological survey that are being used to
uncover these dynamics.</p>
<div class="section level3">
<h3 id="constant-foi">Constant FoI<a class="anchor" aria-label="anchor" href="#constant-foi"></a>
</h3>
<p>We start by assuming that a disease has a constant
<em>Force-of-Infection</em> (FoI) over time.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_age</span> <span class="op">&lt;-</span> <span class="fl">80</span></span>
<span><span class="va">foi_constant</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">max_age</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  foi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="va">max_age</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">foi_constant</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">foi</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-2-1.png" width="768" style="display: block; margin: auto;"></p>
<p>We suppose that we carry out a serological survey which randomly
samples the population. For simplicity, to start, we imagine that all
individual one-year group ages are sampled and the sample size in each
age is the same:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>15</mn></mrow><annotation encoding="application/x-tex">n=15</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_sample</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span><span class="va">survey_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  age_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">max_age</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  age_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">max_age</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  n_sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">n_sample</span>, <span class="va">max_age</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then put these pieces together and simulate a serosurvey. Either a
time-varying FoI model or an age-varying FoI model would produce the
same results here since they are equivalent when the FoI is
constant.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">serosurvey_constant</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_serosurvey.html">simulate_serosurvey</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  foi <span class="op">=</span> <span class="va">foi_constant</span>,</span>
<span>  survey_features <span class="op">=</span> <span class="va">survey_features</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"constant FoI"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">serosurvey_constant</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 80</span></span>
<span><span class="co">#&gt; Columns: 5</span></span>
<span><span class="co">#&gt; $ age_min        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, …</span></span>
<span><span class="co">#&gt; $ age_max        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, …</span></span>
<span><span class="co">#&gt; $ n_sample       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15,…</span></span>
<span><span class="co">#&gt; $ n_seropositive <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 0, 3, 2, 1, 0, 4, 4, 4, 7, 7, 9, 5, 4, 8, 8, 10, 9, 12,…</span></span>
<span><span class="co">#&gt; $ model_type     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "constant FoI", "constant FoI", "constant FoI", "consta…</span></span></code></pre></div>
<p>Now, we can plot the proportions of those seropositive, including the
posterior 95% percentiles (when assuming a flat prior), and plot it
along the true seropositivities (line blue):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_serosurvey.html">plot_serosurvey</a></span><span class="op">(</span><span class="va">serosurvey_constant</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="../reference/prob_seroprev_by_age.html">prob_seroprev_by_age</a></span><span class="op">(</span></span>
<span>      model <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>      foi <span class="op">=</span> <span class="va">foi_constant</span>,</span>
<span>      seroreversion_rate <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">seropositivity</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-5-1.png" alt="Simulated and true proportion" width="768" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="age-varying-foi">Age-varying FoI<a class="anchor" aria-label="anchor" href="#age-varying-foi"></a>
</h3>
<p>We now consider a pathogen which has an FoI that varies throughout
the age of individuals. We assume the FoI declines strongly throughout
childhood.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">max_age</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">foi_age_varying</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  age <span class="op">=</span> <span class="va">ages</span>,</span>
<span>  foi <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">ages</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">foi_age_varying</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">foi</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-6-1.png" width="768" style="display: block; margin: auto;"></p>
<p>We use the same survey design as before and simulate a serological
survey.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">serosurvey_age_dep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_serosurvey.html">simulate_serosurvey</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  foi <span class="op">=</span> <span class="va">foi_age_varying</span>,</span>
<span>  survey_features <span class="op">=</span> <span class="va">survey_features</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"age-dependent FoI"</span><span class="op">)</span></span></code></pre></div>
<p>Below, we see that the FoI for the age-dependent FoI pathogen
increases rapidly during the earliest years then plateaus in later
adulthood as the FoI effectively becomes negligible.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># combine with constant FoI survey</span></span>
<span><span class="va">prob_seroprev_constant</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prob_seroprev_by_age.html">prob_seroprev_by_age</a></span><span class="op">(</span></span>
<span>      model <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>      foi <span class="op">=</span> <span class="va">foi_constant</span>,</span>
<span>      seroreversion_rate <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>age_min <span class="op">=</span> <span class="va">age</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prob_seroprev_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prob_seroprev_by_age.html">prob_seroprev_by_age</a></span><span class="op">(</span></span>
<span>      model <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>      foi <span class="op">=</span> <span class="va">foi_age_varying</span>,</span>
<span>      seroreversion_rate <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>age_min <span class="op">=</span> <span class="va">age</span><span class="op">)</span></span>
<span></span>
<span><span class="va">serosurvey_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">serosurvey_constant</span>,</span>
<span>    <span class="va">prob_seroprev_constant</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"age_min"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">serosurvey_age_dep</span>,</span>
<span>    <span class="va">prob_seroprev_age</span>,</span>
<span>      by <span class="op">=</span> <span class="st">"age_min"</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model_type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_serosurvey.html">plot_serosurvey</a></span><span class="op">(</span>serosurvey <span class="op">=</span> <span class="va">serosurvey_combined</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">serosurvey_combined</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age_min</span>, y <span class="op">=</span> <span class="va">seropositivity</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Seropositivity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">model_type</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-8-1.png" width="768" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="time-dependent-foi">Time-dependent FoI<a class="anchor" aria-label="anchor" href="#time-dependent-foi"></a>
</h3>
<p>We now consider a pathogen where the FoI varies only over calendar
time. We imagine a pathogen that has a ‘spiky’ FoI, characteristic of an
epidemic disease.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foi_spiky</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1946</span>, <span class="fl">2025</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  foi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">foi_spiky</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">foi</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-9-1.png" alt="Spiky FoI" width="768" style="display: block; margin: auto;"></p>
<p>The same serological survey design then produces a serological
profile with distinct patterning.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">serosurvey_spiky</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_serosurvey.html">simulate_serosurvey</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>  foi <span class="op">=</span> <span class="va">foi_spiky</span>,</span>
<span>  survey_features <span class="op">=</span> <span class="va">survey_features</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Again, we can plot the true seropositivities, which highlights the
jumps in seropositivity corresponding to cohorts born either side of
epidemics:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot shows jumps in seropositivity</span></span>
<span><span class="fu"><a href="../reference/plot_serosurvey.html">plot_serosurvey</a></span><span class="op">(</span><span class="va">serosurvey_spiky</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="../reference/prob_seroprev_by_age.html">prob_seroprev_by_age</a></span><span class="op">(</span></span>
<span>      model <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>      foi <span class="op">=</span> <span class="va">foi_spiky</span>,</span>
<span>      seroreversion_rate <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">seropositivity</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Seropositivity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Age"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-11-1.png" alt="Plot showing jumps in seropositivity" width="768" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="age-and-time-dependent-foi">Age-and-time-dependent FoI<a class="anchor" aria-label="anchor" href="#age-and-time-dependent-foi"></a>
</h3>
<p>Many pathogens may have a transmission strength that varies according
to both age and time. An example of this could be for a sexually
transmitted disease where transmission follows a characteristic
age-specific pattern, peaking in the early 20s. Here, we imagine such a
disease which has relatively recently invaded a population.</p>
<p>We imagine the time-specific multiplier of FoI follows the below
variation.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foi_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">40</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">foi_df_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1946</span>, <span class="fl">2025</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  foi <span class="op">=</span> <span class="va">foi_time</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">foi_df_time</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">foi</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-12-1.png" alt="Time-specific multiplier of the FoI" width="768" style="display: block; margin: auto;"></p>
<p>We create a pattern of age-structured FoI multipliers which peaks in
those of early 20s.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">80</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">foi_age</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">dlnorm</a></span><span class="op">(</span></span>
<span>  <span class="va">ages</span>, meanlog <span class="op">=</span> <span class="fl">3.5</span>, sdlog <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">foi_df_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  age <span class="op">=</span> <span class="va">ages</span>,</span>
<span>  foi <span class="op">=</span> <span class="va">foi_age</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">foi_df_age</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">foi</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-13-1.png" alt="Plot of age-structured FoI multipliers" width="768" style="display: block; margin: auto;"></p>
<p>To create the overall FoI (which is a function of both time and age),
we create the product of the time- and age-dependent parts of it.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foi_age_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="va">foi_df_time</span><span class="op">$</span><span class="va">year</span>,</span>
<span>  age <span class="op">=</span> <span class="va">foi_df_age</span><span class="op">$</span><span class="va">age</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">foi_df_age</span>, by <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>foi_age <span class="op">=</span> <span class="va">foi</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">foi_df_time</span>, by <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>foi_time <span class="op">=</span> <span class="va">foi</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>foi <span class="op">=</span> <span class="va">foi_age</span> <span class="op">*</span> <span class="va">foi_time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"foi_age"</span>, <span class="st">"foi_time"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-15-1.png" alt="Plot a few birth years of time- and age-dependent FoI" width="768" style="display: block; margin: auto;"></p>
<p>We now simulate a serosurvey assuming these historical FoIs generated
the population-wide seropositivities in 2025; we make the sample sizes
larger to be able to clearly visualise the patterns in seropositivity.
We also illustrate how serosurveys with wider age-bins can be generated
by choosing 5-year bins.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_age</span> <span class="op">&lt;-</span> <span class="fl">80</span></span>
<span><span class="va">n_sample</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">survey_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  age_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">max_age</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>  age_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="va">max_age</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n_sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">n_sample</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">age_min</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">serosurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_serosurvey.html">simulate_serosurvey</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"age-time"</span>,</span>
<span>  foi <span class="op">=</span> <span class="va">foi_age_time</span>,</span>
<span>  survey_features <span class="op">=</span> <span class="va">survey_features</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"non-seroreverting"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_serosurvey.html">plot_serosurvey</a></span><span class="op">(</span><span class="va">serosurvey</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="../reference/prob_seroprev_by_age.html">prob_seroprev_by_age</a></span><span class="op">(</span></span>
<span>      model <span class="op">=</span> <span class="st">"age-time"</span>,</span>
<span>      foi <span class="op">=</span> <span class="va">foi_age_time</span>,</span>
<span>      seroreversion_rate <span class="op">=</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">seropositivity</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Seropositivity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Age"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-17-1.png" alt="Plot serosurvey obtained simulating from time- and age-dependent FoI" width="768" style="display: block; margin: auto;"></p>
<p>We compare this with a closely related pathogen which exhibits
seroreversion – a process by which individuals lose their antibody
detectability over time. Owing to its seroreversion, this pathogen
produces a seropositivity profile that peaks at a slightly lower level
than previously.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate serosurvey for a seroreverting pathogen</span></span>
<span><span class="va">serosurvey_serorevert</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_serosurvey.html">simulate_serosurvey</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"age-time"</span>,</span>
<span>  foi <span class="op">=</span> <span class="va">foi_age_time</span>,</span>
<span>  survey_features <span class="op">=</span> <span class="va">survey_features</span>,</span>
<span>  seroreversion_rate <span class="op">=</span> <span class="fl">0.01</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"seroreverting"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># combine with constant FoI survey</span></span>
<span><span class="va">prob_seroprev_no_serorev</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prob_seroprev_by_age.html">prob_seroprev_by_age</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"age-time"</span>,</span>
<span>  foi <span class="op">=</span> <span class="va">foi_age_time</span>,</span>
<span>  seroreversion_rate <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>age_min <span class="op">=</span> <span class="va">age</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prob_seroprev_serorev</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prob_seroprev_by_age.html">prob_seroprev_by_age</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"age-time"</span>,</span>
<span>  foi <span class="op">=</span> <span class="va">foi_age_time</span>,</span>
<span>  seroreversion_rate <span class="op">=</span> <span class="fl">0.01</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>age_min <span class="op">=</span> <span class="va">age</span><span class="op">)</span></span>
<span></span>
<span><span class="va">serosurvey_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">serosurvey</span>,</span>
<span>    <span class="va">prob_seroprev_no_serorev</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"age_min"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">serosurvey_serorevert</span>,</span>
<span>    <span class="va">prob_seroprev_serorev</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"age_min"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">model_type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot both</span></span>
<span><span class="fu"><a href="../reference/plot_serosurvey.html">plot_serosurvey</a></span><span class="op">(</span>serosurvey <span class="op">=</span> <span class="va">serosurvey_combined</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">serosurvey_combined</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age_min</span>, y <span class="op">=</span> <span class="va">seropositivity</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Seropositivity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">model_type</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-19-1.png" alt="Plot comparing serosurveys with and without seroreversion" width="768" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="simulating-from-a-general-serological-model">Simulating from a general serological model<a class="anchor" aria-label="anchor" href="#simulating-from-a-general-serological-model"></a>
</h2>
<p>We now illustrate an example age- and time-dependent FoI model for
representing the prevalence of HIV (in the absence of treatment). In the
absence of treatment, HIV invariably ends in death, and death usually
occurs after the onset of AIDS which occurs typically many years after
infection. This means that the time from infection to death has a
characteristic waiting time, which year we model as being around 10
years long.</p>
<p>Our model considers a single susceptible group,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>S</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S^{\tau}(t)</annotation></semantics></math>
indexed by their birth year,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>,
and calendar time,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
There are then a series of consecutive seropositive states,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>X</mi><mi>i</mi><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">X_i^{\tau}(t)</annotation></semantics></math>,
for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mn>1</mn><mo>,</mo><mn>10</mn><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">i\in[1,10]</annotation></semantics></math>;
then finally a dead state,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>D</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">D^{\tau}(t)</annotation></semantics></math>.
By distributing the seropositive population across a range of states,
this model effectively institutes a delay from infection until death.
Our model takes the following form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mrow><mi>d</mi><msup><mi>S</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>−</mo><mi>u</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>v</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>S</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mrow><mi>d</mi><msubsup><mi>X</mi><mn>1</mn><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>u</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>v</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>S</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msubsup><mi>X</mi><mn>1</mn><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mrow><mi>d</mi><msubsup><mi>X</mi><mi>i</mi><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msubsup><mi>X</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msubsup><mi>X</mi><mi>i</mi><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mspace width="1.0em"></mspace><mo>∀</mo><mi>i</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mn>2</mn><mo>,</mo><mn>10</mn><mo stretchy="true" form="postfix">]</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mrow><mi>d</mi><msup><mi>D</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>X</mi><mn>10</mn></msub><mo>,</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation}\label{eq:serocatalytic_hiv}
    \begin{aligned}
        \frac{dS^{\tau}(t)}{dt} &amp;= -u(t-\tau)v(t) S^{\tau}(t)\\
        \frac{dX_1^{\tau}(t)}{dt} &amp;= u(t-\tau)v(t) S^{\tau}(t) - X_1^{\tau}(t)\\
        \frac{dX_i^{\tau}(t)}{dt} &amp;= X_{i-1}^{\tau}(t) - X_{i}^{\tau}(t), \quad \forall i \in [2,10],\\
        \frac{dD^{\tau}(t)}{dt} &amp;= X_{10},
    \end{aligned}
\end{equation}</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>S</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">S^{\tau}(0)=1</annotation></semantics></math>
and all other compartments have initial conditions set to zero. We
assume that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>.</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">u(.)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>.</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">v(.)</annotation></semantics></math>
are piecewise-constant with one-year pieces, with their values the same
as those from the sexually transmitted disease example above.</p>
<p>This model does not fit neatly into our other classes of
serocatalytic models, and, more generally, we cannot produce specific
methods for any foreseeable model structure. But it is possible to find
a general strategy for solving such models by rewriting them as
piecewise-linear systems of ordinary differential equations.</p>
<p>Since the system is linear, we can write it as a vector differential
equation by defining
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝐘</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><mrow><mo stretchy="true" form="prefix">[</mo><msup><mi>S</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msubsup><mi>X</mi><mn>1</mn><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mi>.</mi><mi>.</mi><mi>.</mi><mo>,</mo><msubsup><mi>X</mi><mn>10</mn><mi>τ</mi></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msup><mi>D</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mi>′</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{Y}^{\tau}(t):=[S^{\tau}(t),X_1^{\tau}(t),...,X_{10}^{\tau}(t),D^{\tau}(t)]'</annotation></semantics></math>
as a vector of states and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>𝐀</mi><mo accent="true">‾</mo></mover><mrow><mi>t</mi><mo>,</mo><mi>τ</mi></mrow></msub><annotation encoding="application/x-tex">\bar{\boldsymbol{A}}_{t,\tau}</annotation></semantics></math>
as a matrix of constants that are fixed for a given year and year of
birth:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>𝐀</mi><mo accent="true">‾</mo></mover><mrow><mi>t</mi><mo>,</mo><mi>τ</mi></mrow></msub><mo>:=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mo>−</mo><mover><mi>u</mi><mo accent="true">‾</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mover><mi>v</mi><mo accent="true">‾</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>u</mi><mo accent="true">‾</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mover><mi>v</mi><mo accent="true">‾</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo><mn>1</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>1</mn></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo><mn>1</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>1</mn></mtd><mtd columnalign="center" style="text-align: center"><mo>−</mo><mn>1</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>1</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">\begin{equation}
    \bar{\boldsymbol{A}}_{t,\tau} := \begin{bmatrix}
-\bar u(t-\tau) \bar v(t) &amp; 0 &amp; \cdots \\
\bar u(t-\tau) \bar v(t) &amp; -1 &amp; 0 &amp; \cdots\\
0 &amp; 1 &amp; -1 &amp; 0 &amp; \cdots\\
0 &amp; 0 &amp; 1 &amp; -1 &amp; 0 &amp; \cdots\\
\vdots &amp; \vdots &amp; \ddots &amp; \ddots &amp; \ddots &amp; \ddots\\
0 &amp; \cdots &amp; &amp; 0 &amp; 1 &amp; 0
\end{bmatrix}.
\end{equation}</annotation></semantics></math></p>
<p>Using this matrix, we can write and solve the system of
equations:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><msup><mi>𝐘</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><msub><mover><mi>𝐀</mi><mo accent="true">‾</mo></mover><mrow><mi>t</mi><mo>,</mo><mi>τ</mi></mrow></msub><msup><mi>𝐘</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⟹</mo><msup><mi>𝐘</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝐀</mi><mo accent="true">‾</mo></mover><mrow><mi>t</mi><mo>,</mo><mi>τ</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>𝐘</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">\begin{equation}
    \frac{d\boldsymbol{Y}^{\tau}(t)}{dt} = \bar{\boldsymbol{A}}_{t,\tau} \boldsymbol{Y}^{\tau}(t) \implies \boldsymbol{Y}^{\tau}(t+1) = \exp(\bar{\boldsymbol{A}}_{t,\tau}) \boldsymbol{Y}^{\tau}(t).
\end{equation}</annotation></semantics></math></p>
<p>where we have used matrix exponentials to find the solution because
the individual algebraic expressions are unwieldy with this many
compartments. This matrix form means that a general solution for the
system can be written down as follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝐘</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mi>′</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mover><mi>𝐀</mi><mo accent="true">‾</mo></mover><mrow><mi>t</mi><mi>′</mi><mo>,</mo><mi>τ</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>𝐘</mi><mi>τ</mi></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">\begin{equation}
    \boldsymbol{Y}^{\tau}(t) = \exp\left(\sum_{t'=1}^{t}\bar{\boldsymbol{A}}_{t',\tau}\right) \boldsymbol{Y}^{\tau}(0).
\end{equation}</annotation></semantics></math></p>
<p>We now illustrate how such a system can be solved and used to
simulate a serosurvey using <code>serofoi</code>. The key to this is
writing a method for constructing the matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐀</mi><mrow><mi>t</mi><mi>′</mi><mo>,</mo><mi>τ</mi></mrow></msub><annotation encoding="application/x-tex">\boldsymbol{A}_{t',\tau}</annotation></semantics></math>
in the above expression.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use same age- and time-specific multipliers</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="va">foi_df_age</span><span class="op">$</span><span class="va">foi</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">foi_df_time</span><span class="op">$</span><span class="va">foi</span></span>
<span></span>
<span><span class="co"># function to construct A matrix for one piece</span></span>
<span><span class="va">construct_A</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">tau</span>, <span class="va">u</span>, <span class="va">v</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">u_bar</span> <span class="op">&lt;-</span> <span class="va">u</span><span class="op">[</span><span class="va">t</span> <span class="op">-</span> <span class="va">tau</span><span class="op">]</span></span>
<span>  <span class="va">v_bar</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">[</span><span class="va">t</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, ncol <span class="op">=</span> <span class="fl">12</span>, nrow <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span>  <span class="va">A</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/row.html" class="external-link">row</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">==</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/col.html" class="external-link">col</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">A</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">u_bar</span> <span class="op">*</span> <span class="va">v_bar</span></span>
<span>  <span class="va">A</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">u_bar</span> <span class="op">*</span> <span class="va">v_bar</span></span>
<span>  <span class="va">A</span><span class="op">[</span><span class="fl">12</span>, <span class="fl">12</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span>  <span class="va">A</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># determines the sum of seropositive compartments of those still alive</span></span>
<span><span class="va">calculate_seropositivity_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">11</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Y</span><span class="op">[</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># initial conditions in 12D state vector</span></span>
<span><span class="va">initial_conditions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">initial_conditions</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># solve</span></span>
<span><span class="va">seropositive_hiv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prob_seroprev_gen_by_age.html">prob_seroprev_gen_by_age</a></span><span class="op">(</span></span>
<span>    <span class="va">construct_A</span>,</span>
<span>    <span class="va">calculate_seropositivity_fn</span>,</span>
<span>    <span class="va">initial_conditions</span>,</span>
<span>    max_age <span class="op">=</span> <span class="fl">80</span>,</span>
<span>    <span class="va">u</span>,</span>
<span>    <span class="va">v</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">seropositive_hiv</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">seropositivity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Seropositivity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Age"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-20-1.png" alt="Plot HIV seroprevalence example using the general model" width="768" style="display: block; margin: auto;"></p>
<p>We can also simulate a serosurvey assuming the above model.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">serosurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_serosurvey_general.html">simulate_serosurvey_general</a></span><span class="op">(</span></span>
<span>    <span class="va">construct_A</span>,</span>
<span>    <span class="va">calculate_seropositivity_fn</span>,</span>
<span>    <span class="va">initial_conditions</span>,</span>
<span>    <span class="va">survey_features</span>,</span>
<span>    <span class="va">u</span>,</span>
<span>    <span class="va">v</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot</span></span>
<span><span class="fu"><a href="../reference/plot_serosurvey.html">plot_serosurvey</a></span><span class="op">(</span><span class="va">serosurvey</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">seropositive_hiv</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">seropositivity</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent</a></span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Seropositivity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Age"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulating_serosurveys_files/figure-html/unnamed-chunk-22-1.png" alt="Plot HIV simulated serosurvey using the general model" width="768" style="display: block; margin: auto;"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Zulma M. Cucunubá, Nicolás T. Domínguez, Ben Lambert, Pierre Nouvellet, International Development Research Center (IDRC).</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
